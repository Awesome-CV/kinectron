<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
    <script src="peer.min.js"></script>
    <script type="text/JavaScript">
      var Kinect2 = require('kinect2');
      var kinect = new Kinect2();

      var mypeerid = null;
      var peer = null;
      var peer_ids = [];
      var peer_connections = [];

      var canvas = null;
      var context = null;
      var imageData = null;
      var imageDataSize = null;
      var imageDataArray = null;

      var busy = false;

      function initpeer() {
          peer = new Peer('shawn',{host: 'liveweb.itp.io', port: 9000, path: '/', secure: true});

          peer.on('error',function(err) {
            console.log(err);
          });

          peer.on('open', function(id) {
            console.log('My peer ID is: ' + id);
            mypeerid = id;
        });

        peer.on('connection', function(conn) {
          connection = conn;
          console.log("Got a new data connection from peer: "+connection.peer);
          peer_connections.push(connection);

          connection.on('open', function() {
            console.log("Connection opened.");
          });
          connection.on('data', function(data) {
            console.log("Data Received: "+data);
          });
        });

      }

      function sendToPeer(evt, data) {
        var dataToSend = {"event": evt, "data": data};
        peer_connections.forEach(function(connection) {
          connection.send(dataToSend);
        });
      }

      function startTracking() {
            if (kinect.open()) {
      	       console.log("Kinect Opened");

               //listen for body frames
      	        kinect.on('bodyFrame', function(bodyFrame){
                  sendToPeer('bodyFrame',bodyFrame);
      		          // for (var i = 0;  i < bodyFrame.bodies.length; i++) {
      			        //      if (bodyFrame.bodies[i].tracked) {
                    //        console.log("Tracked");
                    //        sendToPeer('bodyFrame',bodyFrame);
                    //        console.log(bodyFrame);
      			        //      }
      		          // }
      	        });

      	        //request body frames
      	        kinect.openBodyReader();
            }
      }

      function stopTracking() {
        kinect.close();
      }


      function startRGB() {

        if(kinect.open()) {
          kinect.on('colorFrame', function(newPixelData){
            if(busy) {
              return;
            }
            busy = true;
            //sendToPeer('colorFrame',newPixelData);

            for (var i = 0; i < imageDataSize; i++) {
              imageDataArray[i] = newPixelData[i];
            }
            context.putImageData(imageData, 0, 0);
            busy = false;
          });
        }
        kinect.openColorReader();

      }

      function stopRGB() {
        kinect.closeColorReader();
        busy = false;
      }

      function loadFile(e) {
        //console.log(e);
        window.location.href = e.target.files[0].path;
      }

      function init() {
        document.getElementById('loadfile').addEventListener('change',loadFile);
        canvas = document.getElementById('outputCanvas');
        context = canvas.getContext('2d');
        imageData = context.createImageData(canvas.width, canvas.height);
        imageDataSize = imageData.data.length;
        imageDataArray = imageData.data;
      }

      window.addEventListener('load',initpeer);
      window.addEventListener('load',init);
</script>

  </head>
  <body style="background-color: white;">
    <h1>Hello Kinect!</h1>

    <br />
    <input type="button" value="Start Skeleton Tracking" onclick="startTracking();">
    <input type="button" value="Stop Skeleton Tracking" onclick="stopTracking();">
    <br />
    <input type="button" value="Start RGB Camera" onclick="startRGB();">
    <input type="button" value="Stop RGB Camera" onclick="stopRGB();">
    <br />
    <canvas id="outputCanvas" width="1920" height="1080"></canvas>
    <br />
    Load a different page:
    <input type="file" id="loadfile">
  </body>
</html>
