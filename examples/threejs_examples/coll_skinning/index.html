<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - collada - skinning</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #000;
				font-family:Monospace;
				font-size:13px;
				text-align:center;

				background-color: #000;
				margin: 0px;
				overflow: hidden;
			}...sha..sharedd

			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
			}

			a {

				color: #f00;
			}

		</style>
	</head>
	<body>

		<div id="container"></div>

		<div id="info">
		<a href="http://threejs.org" target="_blank">three.js</a> webgl - collada - skinning
		</div>
		<script src="https://itp.nyu.edu/kinectron/kinectron.bundle.js" type="text/javascript"></script>
		<script src="../shared/three.min.js"></script>
		<script src="../shared/loaders/collada/Animation.js"></script>
		<script src="../shared/loaders/collada/AnimationHandler.js"></script>
		<script src="../shared/loaders/collada/KeyFrameAnimation.js"></script>
		<script src="../shared/loaders/ColladaLoader.js"></script>
		<script src="../shared/OrbitControls.js"></script>
		<script src="../shared/Detector.js"></script>
		<script src="../shared/stats.min.js"></script>

		<script>

			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var container, stats;
			var camera, scene, renderer;
			var clock = new THREE.Clock();

			var joints = [];

			var geo;
			var skeleton;
			var fontGlo;

			init();

			function init() {



				container = document.getElementById( 'container' );

				camera = new THREE.PerspectiveCamera( 25, window.innerWidth / window.innerHeight, 1, 10000 );
				camera.position.set( -5, -5, 5 );
				camera.up.set( 0, 0, 1 );

				scene = new THREE.Scene();


				var fontLoader = new THREE.FontLoader();

				fontLoader.load( '../shared/fonts/helvetiker_regular.typeface.json', function ( infont ) {
					fontGlo = infont;
					initModel();

	    		

				} );



				
				var light = new THREE.DirectionalLight( 0xffffff, 1.5 );
				light.position.set( 0, -4, -4 ).normalize();
				scene.add( light );

				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setClearColor( 0xfff4e5 );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.sortObjects = false;
				container.appendChild( renderer.domElement );

				stats = new Stats();
				container.appendChild( stats.dom );
				




				controls = new THREE.OrbitControls( camera, renderer.domElement );
				window.addEventListener( 'resize', onWindowResize, false );

				animate();

			}



			function initModel() {
				var loader = new THREE.ColladaLoader();
				loader.load( "../shared/models/collada/avatar.dae", function ( collada ) {
				
					collada.scene.traverse( function ( child ) {

						if ( child instanceof THREE.SkinnedMesh ) {
							skeleton = child.skeleton;
							console.log(child);
							//debugger;

							// geo = child.geometry;
							// joints = child.geometry.bones;
							
							// var animation = new THREE.Animation( child, child.geometry.animation );
							// animation.play();

							camera.lookAt( child.position );

																						 // Create cubes for joints    
			  for (var j = 0; j < 25; j++) {
			    var material1 = new THREE.MeshPhongMaterial( { color: 0xff0000 }  );
			    //var material = new THREE.MeshBasicMaterial({ color: 0x3b0160 });
			    var geometry1 = new THREE.BoxGeometry( 0.1, 0.1, 0.1 );
			    geometry1.applyMatrix( new THREE.Matrix4().makeTranslation( 0, 0, 0 ) );
			    var mesh1 = new THREE.Mesh( geometry1, material1 );

			    if (skeleton.bones[j]) {
						var x1 = skeleton.bones[j].position.x;
						var y1 = skeleton.bones[j].position.y;
						var z1 = skeleton.bones[j].position.z;
						console.log(j, x1, y1, z1);
						mesh1.position.set(x1,y1,z1); 	
					} else {
						//mesh1.position.set(20,20,0);
						mesh1.visible = false;
					}

			    joints.push( mesh1 );
			    scene.add( mesh1 ); 
			  }

						}

					} );

					// console.log(loader);
					// debugger;

					scene.add( collada.scene );

				} );






				kinectron = new Kinectron();

			  // Connect to the microstudio
			  //kinectron = new Kinectron("kinectron.itp.tsoa.nyu.edu");

			  // Connect remote to application
			  kinectron.makeConnection();
			  //kinectron.startMultiFrame(["color", "depth"], changeCanvas);
			  kinectron.startTrackedBodies(drawJoints);

			}



			function drawJoints(data) {
				 for (var j = 0; j < joints.length; j++ ) {
			    joints[j].position.x = data.joints[j].cameraX * window.innerWidth/100;
			    joints[j].position.y = data.joints[j].cameraY* -window.innerHeight/100;;
			    joints[j].position.z = 0;
			    //joints[j].position.z = data.joints[j].cameraZ * -window.innerWidth/40;
			    //joints[j].rotation.x = data.joints[j].orientationX;
			    //joints[j].rotation.y = data.joints[j].orientationY;
			    //joints[j].rotation.z = data.joints[j].orientationZ;
			  }


					// pelvis - spine base 
					skeleton.bones[20].quaternion.x = data.joints[0].orientationX;
				  skeleton.bones[20].quaternion.y = data.joints[0].orientationY; 
				  skeleton.bones[20].quaternion.z = data.joints[0].orientationZ;
				  skeleton.bones[20].quaternion.w = data.joints[0].orientationW;

				  //head - head
				  skeleton.bones[0].quaternion.x = data.joints[3].orientationX;
				  skeleton.bones[0].quaternion.y = data.joints[3].orientationY; 
				  skeleton.bones[0].quaternion.z = data.joints[3].orientationZ;
				  skeleton.bones[0].quaternion.w = data.joints[3].orientationW;
					//neck - head
				  skeleton.bones[12].quaternion.x = data.joints[20].orientationX;
				  skeleton.bones[12].quaternion.y = data.joints[20].orientationY; 
				  skeleton.bones[12].quaternion.z = data.joints[20].orientationZ;
				  skeleton.bones[12].quaternion.w = data.joints[20].orientationW;
				 
				  //spine - spine mid 
				  skeleton.bones[19].quaternion.x = data.joints[1].orientationX;
				  skeleton.bones[19].quaternion.y = data.joints[1].orientationY; 
				  skeleton.bones[19].quaternion.z = data.joints[1].orientationZ;
				  skeleton.bones[19].quaternion.w = data.joints[1].orientationW;

				  //l clavicle - shoulder left
				  skeleton.bones[11].quaternion.x = data.joints[4].orientationX;
				  skeleton.bones[11].quaternion.y = data.joints[4].orientationY; 
				  skeleton.bones[11].quaternion.z = data.joints[4].orientationZ;
				  skeleton.bones[11].quaternion.w = data.joints[4].orientationW;

				  // //l upperarm - elbow left
				  skeleton.bones[10].quaternion.x = data.joints[5].orientationX;
				  skeleton.bones[10].quaternion.y = data.joints[5].orientationY; 
				  skeleton.bones[10].quaternion.z = data.joints[5].orientationZ;
				  skeleton.bones[10].quaternion.w = data.joints[5].orientationW;

				  //l forearm - wrist left 
				  skeleton.bones[9].quaternion.x = data.joints[6].orientationX;
				  skeleton.bones[9].quaternion.y = data.joints[6].orientationY; 
				  skeleton.bones[9].quaternion.z = data.joints[6].orientationZ;
				  skeleton.bones[9].quaternion.w = data.joints[6].orientationW;
				  
				  //l hand - hand bones left 
				  skeleton.bones[8].quaternion.x = data.joints[7].orientationX;
				  skeleton.bones[8].quaternion.y = data.joints[7].orientationY; 
				  skeleton.bones[8].quaternion.z = data.joints[7].orientationZ;
				  skeleton.bones[8].quaternion.w = data.joints[7].orientationW;


				  //r clavicle - shoulder right
				  skeleton.bones[6].quaternion.x = data.joints[8].orientationX;
				  skeleton.bones[6].quaternion.y = data.joints[8].orientationY; 
				  skeleton.bones[6].quaternion.z = data.joints[8].orientationZ;
				  skeleton.bones[6].quaternion.w = data.joints[8].orientationW;

				  // r upperarm - elbow right
				  skeleton.bones[5].quaternion.x = data.joints[9].orientationX;
				  skeleton.bones[5].quaternion.y = data.joints[9].orientationY; 
				  skeleton.bones[5].quaternion.z = data.joints[9].orientationZ;
				  skeleton.bones[5].quaternion.w = data.joints[9].orientationW;

				  //r forearm - wrist right
				  skeleton.bones[4].quaternion.x = data.joints[10].orientationX;
				  skeleton.bones[4].quaternion.y = data.joints[10].orientationY; 
				  skeleton.bones[4].quaternion.z = data.joints[10].orientationZ;
				  skeleton.bones[4].quaternion.w = data.joints[10].orientationW;
				  
				  //r hand - hand right
				  skeleton.bones[3].quaternion.x = data.joints[11].orientationX;
				  skeleton.bones[3].quaternion.y = data.joints[11].orientationY; 
				  skeleton.bones[3].quaternion.z = data.joints[11].orientationZ;
				  skeleton.bones[3].quaternion.w = data.joints[11].orientationW;

				  //l thigh - knee left
				  skeleton.bones[18].quaternion.x = data.joints[13].orientationX;
				  skeleton.bones[18].quaternion.y = data.joints[13].orientationY; 
				  skeleton.bones[18].quaternion.z = data.joints[13].orientationZ;
				  skeleton.bones[18].quaternion.w = data.joints[13].orientationW;

				  //l calf - ankle left
				  skeleton.bones[17].quaternion.x = data.joints[14].orientationX;
				  skeleton.bones[17].quaternion.y = data.joints[14].orientationY; 
				  skeleton.bones[17].quaternion.z = data.joints[14].orientationZ;
				  skeleton.bones[17].quaternion.w = data.joints[14].orientationW;

				  //l foot - foot
				  skeleton.bones[16].quaternion.x = data.joints[15].orientationX;
				  skeleton.bones[16].quaternion.y = data.joints[15].orientationY; 
				  skeleton.bones[16].quaternion.z = data.joints[15].orientationZ;
				  skeleton.bones[16].quaternion.w = data.joints[15].orientationW;

				  //l toe - footleft
				  // skeleton.bones[2].quaternion.x = data.joints[15].orientationX;
				  // skeleton.bones[2].quaternion.y = data.joints[15].orientationY; 
				  // skeleton.bones[2].quaternion.z = data.joints[15].orientationZ;
				  // skeleton.bones[2].quaternion.w = data.joints[15].orientationW;

			  	//r thigh - knee right
				  skeleton.bones[15].quaternion.x = data.joints[17].orientationX;
				  skeleton.bones[15].quaternion.y = data.joints[17].orientationY; 
				  skeleton.bones[15].quaternion.z = data.joints[17].orientationZ;
				  skeleton.bones[15].quaternion.w = data.joints[17].orientationW;

				  //r calf - ankle right
				  skeleton.bones[14].quaternion.x = data.joints[18].orientationX;
				  skeleton.bones[14].quaternion.y = data.joints[18].orientationY; 
				  skeleton.bones[14].quaternion.z = data.joints[18].orientationZ;
				  skeleton.bones[14].quaternion.w = data.joints[18].orientationW;

				  //r foot - foot right
				  skeleton.bones[13].quaternion.x = data.joints[19].orientationX;
				  skeleton.bones[13].quaternion.y = data.joints[19].orientationY; 
				  skeleton.bones[13].quaternion.z = data.joints[19].orientationZ;
				  skeleton.bones[13].quaternion.w = data.joints[19].orientationW;

				  //r toe - foot right
				  // skeleton.bones[7].quaternion.x = data.joints[19].orientationX;
				  // skeleton.bones[7].quaternion.y = data.joints[19].orientationY; 
				  // skeleton.bones[7].quaternion.z = data.joints[19].orientationZ;
				  // skeleton.bones[7].quaternion.w = data.joints[19].orientationW;
}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {


				// if (joints.length > 0) {

				// 	geo.verticesNeedUpdate = true;

				// 	joints[0].pos[0] +=5;
				// 	joints[1].pos[0] +=5;
				// 	joints[2].pos[2] +=5;
				// 	joints[4].pos[5] +=5;
						
				// }
				requestAnimationFrame( animate, renderer.domElement );

				THREE.AnimationHandler.update( clock.getDelta() );

				renderer.render( scene, camera );

				stats.update();

			}

		</script>

	</body>
</html>
