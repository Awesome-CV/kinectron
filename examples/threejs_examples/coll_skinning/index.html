<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - collada - skinning</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #000;
				font-family:Monospace;
				font-size:13px;
				text-align:center;

				background-color: #000;
				margin: 0px;
				overflow: hidden;
			}...sha..sharedd

			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
			}

			a {

				color: #f00;
			}

		</style>
	</head>
	<body>

		<div id="container"></div>

		<div id="info">
		<a href="http://threejs.org" target="_blank">three.js</a> webgl - collada - skinning
		</div>
		<script src="https://itp.nyu.edu/kinectron/kinectron.bundle.js" type="text/javascript"></script>
		<script src="../shared/three.min.js"></script>
		<script src="../shared/loaders/collada/Animation.js"></script>
		<script src="../shared/loaders/collada/AnimationHandler.js"></script>
		<script src="../shared/loaders/collada/KeyFrameAnimation.js"></script>
		<script src="../shared/loaders/ColladaLoader.js"></script>
		<script src="../shared/OrbitControls.js"></script>
		<script src="../shared/Detector.js"></script>
		<script src="../shared/stats.min.js"></script>

		<script>

			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var container, stats;
			var camera, scene, renderer;
			var clock = new THREE.Clock();

			var joints = [];
			var geo;
			var skeleton;
			var fontGlo;

			init();

			function init() {



				container = document.getElementById( 'container' );

				camera = new THREE.PerspectiveCamera( 25, window.innerWidth / window.innerHeight, 1, 10000 );
				camera.position.set( -5, -5, 5 );
				camera.up.set( 0, 0, 1 );

				scene = new THREE.Scene();


				var fontLoader = new THREE.FontLoader();

				fontLoader.load( '../shared/fonts/helvetiker_regular.typeface.json', function ( infont ) {
					fontGlo = infont;
					initModel();

	    		

				} );
				// var fontLoader = new THREE.FontLoader();
				// fontLoader.load('../shared/fonts/helvetiker_regular.typeface.json', function ( inFont ) {
				// 		console.log('loaded');
				// 		scene.add(inFont);

				// 	}
				// );

				
				var light = new THREE.DirectionalLight( 0xffffff, 1.5 );
				light.position.set( 0, -4, -4 ).normalize();
				scene.add( light );

				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setClearColor( 0xfff4e5 );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.sortObjects = false;
				container.appendChild( renderer.domElement );

				stats = new Stats();
				container.appendChild( stats.dom );
				


				controls = new THREE.OrbitControls( camera, renderer.domElement );
				window.addEventListener( 'resize', onWindowResize, false );

				animate();

			}



			function initModel() {
				var loader = new THREE.ColladaLoader();
				loader.load( "../shared/models/collada/avatar.dae", function ( collada ) {
				
					collada.scene.traverse( function ( child ) {

						if ( child instanceof THREE.SkinnedMesh ) {
							skeleton = child.skeleton;
							var bones = skeleton.bones;

							// geo = child.geometry;
							// joints = child.geometry.bones;
							
							// var animation = new THREE.Animation( child, child.geometry.animation );
							// animation.play();

							camera.lookAt( child.position );

						}

					} );

					// console.log(loader);
					// debugger;

					scene.add( collada.scene );

				} );



				kinectron = new Kinectron();

			  // Connect to the microstudio
			  //kinectron = new Kinectron("kinectron.itp.tsoa.nyu.edu");

			  // Connect remote to application
			  kinectron.makeConnection();
			  //kinectron.startMultiFrame(["color", "depth"], changeCanvas);
			  kinectron.startTrackedBodies(drawJoints);

			}



			function drawJoints(data) {
					// pelvis - spine base 
					skeleton.bones[20].position.x = data.joints[0].cameraX;
				  skeleton.bones[20].position.y = data.joints[0].cameraY; 
				  skeleton.bones[20].position.z = data.joints[0].cameraZ;

				  //head - head
				  skeleton.bones[0].position.x = data.joints[3].cameraX;
				  skeleton.bones[0].position.y = data.joints[3].cameraY; 
				  skeleton.bones[0].position.z = data.joints[3].cameraZ;

					//neck - head
				  skeleton.bones[12].position.x = data.joints[2].cameraX;
				  skeleton.bones[12].position.y = data.joints[2].cameraY; 
				  skeleton.bones[12].position.z = data.joints[2].cameraZ;

				  //spine - spine mid 
				  skeleton.bones[19].position.x = data.joints[1].cameraX;
				  skeleton.bones[19].position.y = data.joints[1].cameraY; 
				  skeleton.bones[19].position.z = data.joints[1].cameraZ;

				  //l clavicle - shoulder left
				  skeleton.bones[11].position.x = data.joints[4].cameraX;
				  skeleton.bones[11].position.y = data.joints[4].cameraY; 
				  skeleton.bones[11].position.z = data.joints[4].cameraZ;

				  // //l upperarm - shoulder left
				  // skeleton.bones[10].position.x = data.joints[4].cameraX;
				  // skeleton.bones[10].position.y = data.joints[4].cameraY; 
				  // skeleton.bones[10].position.z = data.joints[4].cameraZ;

				  //l forearm - elbow left 
				  skeleton.bones[9].position.x = data.joints[5].cameraX;
				  skeleton.bones[9].position.y = data.joints[5].cameraY; 
				  skeleton.bones[9].position.z = data.joints[5].cameraZ;
				  
				  //l hand - hand left 
				  skeleton.bones[8].position.x = data.joints[7].cameraX;
				  skeleton.bones[8].position.y = data.joints[7].cameraY; 
				  skeleton.bones[8].position.z = data.joints[7].cameraZ;


				  //r clavicle - shoulder right
				  skeleton.bones[6].position.x = data.joints[8].cameraX;
				  skeleton.bones[6].position.y = data.joints[8].cameraY; 
				  skeleton.bones[6].position.z = data.joints[8].cameraZ;

				  // r upperarm - shoulder right
				  // skeleton.bones[5].position.x = data.joints[4].cameraX;
				  // skeleton.bones[5].position.y = data.joints[4].cameraY; 
				  // skeleton.bones[5].position.z = data.joints[4].cameraZ;

				  //r forearm - elbow right
				  skeleton.bones[4].position.x = data.joints[9].cameraX;
				  skeleton.bones[4].position.y = data.joints[9].cameraY; 
				  skeleton.bones[4].position.z = data.joints[9].cameraZ;
				  
				  //r hand - hand right
				  skeleton.bones[3].position.x = data.joints[11].cameraX;
				  skeleton.bones[3].position.y = data.joints[11].cameraY; 
				  skeleton.bones[3].position.z = data.joints[11].cameraZ;

				  //l thigh - hip left
				  skeleton.bones[18].position.x = data.joints[12].cameraX;
				  skeleton.bones[18].position.y = data.joints[12].cameraY; 
				  skeleton.bones[18].position.z = data.joints[12].cameraZ;

				  //l calf - knee left
				  skeleton.bones[17].position.x = data.joints[13].cameraX;
				  skeleton.bones[17].position.y = data.joints[13].cameraY; 
				  skeleton.bones[17].position.z = data.joints[13].cameraZ;

				  //l foot - ankleleft
				  skeleton.bones[16].position.x = data.joints[14].cameraX;
				  skeleton.bones[16].position.y = data.joints[14].cameraY; 
				  skeleton.bones[16].position.z = data.joints[14].cameraZ;

				  //l toe - footleft
				  skeleton.bones[2].position.x = data.joints[15].cameraX;
				  skeleton.bones[2].position.y = data.joints[15].cameraY; 
				  skeleton.bones[2].position.z = data.joints[15].cameraZ;

				  //r thigh - hip right
				  skeleton.bones[15].position.x = data.joints[16].cameraX;
				  skeleton.bones[15].position.y = data.joints[16].cameraY; 
				  skeleton.bones[15].position.z = data.joints[16].cameraZ;

				  //r calf - knee right
				  skeleton.bones[14].position.x = data.joints[17].cameraX;
				  skeleton.bones[14].position.y = data.joints[17].cameraY; 
				  skeleton.bones[14].position.z = data.joints[17].cameraZ;

				  //r foot - ankle right
				  skeleton.bones[13].position.x = data.joints[18].cameraX;
				  skeleton.bones[13].position.y = data.joints[18].cameraY; 
				  skeleton.bones[13].position.z = data.joints[18].cameraZ;

				  //r toe - foot right
				  skeleton.bones[7].position.x = data.joints[19].cameraX;
				  skeleton.bones[7].position.y = data.joints[19].cameraY; 
				  skeleton.bones[7].position.z = data.joints[19].cameraZ;

}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {


				// if (joints.length > 0) {

				// 	geo.verticesNeedUpdate = true;

				// 	joints[0].pos[0] +=5;
				// 	joints[1].pos[0] +=5;
				// 	joints[2].pos[2] +=5;
				// 	joints[4].pos[5] +=5;
						
				// }
				requestAnimationFrame( animate, renderer.domElement );

				THREE.AnimationHandler.update( clock.getDelta() );

				renderer.render( scene, camera );

				stats.update();

			}

		</script>

	</body>
</html>
